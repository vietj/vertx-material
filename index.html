<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.7.1">
<meta name="author" content="Julien Viet">
<title>Advanced Vert.x Guide</title>
<style>
@import url(http://fonts.googleapis.com/css?family=Lato:400,700,700italic,400italic);
@import url(http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.css);
/* Inspired by the O'Reilly typography and the Atlas user manual | http://oreilly.com */
/* normalize.css v2.1.1 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address styling not present in IE 8/9. */
[hidden] { display: none; }

/* ========================================================================== Base ========================================================================== */
/** 1. Prevent system color scheme's background color being used in Firefox, IE, and Opera. 2. Prevent system color scheme's text color being used in Firefox, IE, and Opera. 3. Set default font family to sans-serif. 4. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { background: #fff; /* 1 */ color: #000; /* 2 */ font-family: sans-serif; /* 3 */ -ms-text-size-adjust: 100%; /* 4 */ -webkit-text-size-adjust: 100%; /* 4 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

a:focus { outline: none; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #191919; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #1f3c99; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #1b3484; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Lato, sans-serif; font-weight: bold; font-style: normal; color: #191919; text-rendering: optimizeLegibility; margin-top: 1.25em; margin-bottom: 0.45em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #666666; line-height: 0; }

h1 { font-size: 1.75em; }

h2 { font-size: 1em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.125em; }

h4 { font-size: 0.75em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Monaco", "Liberation Mono", Courier, monospace; font-weight: normal; color: #191919; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }

ul, ol { margin-left: 0; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3125em; font-weight: normal; }
dl dd { margin-bottom: 1.25em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #191919; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #4c4c4c; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #4c4c4c; }

blockquote, blockquote p { line-height: 1.4; color: #191919; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.375em; }
  h2 { font-size: 1.625em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.4375em; }
  h4 { font-size: 1.0625em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #d8d8d8; }
table thead, table tfoot { background: none; font-weight: normal; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.25em; font-size: inherit; color: #191919; text-align: left; }
table tr th, table tr td { padding: 0.3125em; font-size: inherit; color: #191919; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f0f0f0; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: 0.9em; padding: 0; white-space: nowrap; background-color: inherit; border: 0 solid #dddddd; -webkit-border-radius: 5px; border-radius: 5px; text-shadow: none; }

pre, pre > code { line-height: 1.6; color: white; font-family: Consolas, Monaco, "Lucida Console", Courier, monospace; font-weight: normal; }

kbd.keyseq { color: #4c4c4c; }

kbd:not(.keyseq) { display: inline-block; color: #191919; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: black; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.5em; }
#header > h1 { color: white; font-weight: bold; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #191919; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 1.25em; }
#toc > ul { margin-left: 0.25em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }

#toctitle { color: #191919; }

@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.25em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: lightgrey; margin-bottom: 1.25em; padding: 1.25em; background: #ededed; border-width: 0; -webkit-border-radius: 5px; border-radius: 5px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }

#content #toctitle { font-weight: bold; font-family: Georgia, "Times New Roman", serif; font-size: 1em; padding-left: 0.125em; }

#footer { max-width: 100%; background-color: white; padding: 1.25em; }

#footer-text { color: #333333; line-height: 1.26; }

.sect1 { padding-bottom: 1.25em; }

.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #191919; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #0c0c0c; }

.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #191919; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 5px; border-radius: 5px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #191919; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #bfbfbf; box-shadow: 0 1px 8px #bfbfbf; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: lightgrey; margin-bottom: 1.25em; padding: 1.25em; background: #ededed; -webkit-border-radius: 5px; border-radius: 5px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #191919; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #191919; margin-top: 0; line-height: 1.4; border-width: 0 0 1px 0; border-style: solid; border-color: #bfbfbf; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock > .content pre, .listingblock > .content pre { background: #333333; border-width: 1px; border-style: solid; border-color: #dddddd; -webkit-border-radius: 5px; border-radius: 5px; padding: 1.0625em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.72em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.81em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.9em; } }

.listingblock > .content { position: relative; }

.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.375em; right: 0.375em; }

.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }

table.pyhltable { border: 0; margin-bottom: 0; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }

.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: 0.8125em; color: #4c4c4c; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }

table thead th, table tfoot th { font-weight: normal; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 5px; border-radius: 5px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }

th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }

th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }

p.tableblock.header { color: #191919; font-weight: normal; }

td > div.verse { white-space: pre; }

ol { margin-left: 0.25em; }

ul li ol { margin-left: 0; }

dl dd { margin-left: 2.5em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.625em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.625em auto; margin-left: -1.375em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.375em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .8em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }

.qanda > ol > li > p > em:only-child { color: #1b3484; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em; line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #1f3c99; color: #172d73; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: #191919; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

.imageblock, .literalblock, .listingblock, .sidebarblock { margin-left: -0.9375em; margin-right: -0.9375em; }

body { background: linear-gradient(270deg, #333333 0%, #333333 100%) no-repeat 0 0/100% 178px; background: -webkit-linear-gradient(270deg, #333333 0, #333333 100%) no-repeat 0 0/100% 178px; }

#header { margin-bottom: 4em; }
#header > h1 { border-bottom: none; margin-bottom: -28px; margin-top: 2em; }
#header span { color: white; }
#header #toc { padding-top: 2em; margin-bottom: -4em; }

.sect1:not(:last-child) { padding-bottom: 0; }

#toc ol li ol, #toc ol li ul { padding-left: 40px; }

#toctitle { letter-spacing: -1px; }

#content h2, #content h3, #content #toctitle, #content .sidebarblock > .content > .title, #content h4, #content h5 { letter-spacing: -1px; }

dl dt { font-style: italic; }

.ulist > ul, .olist > ol { margin-left: 0; padding-left: 40px; }

.admonitionblock > table { border: 0 solid #bfbfbf; border-width: 1px 0; background-color: #f7f7f7; }
.admonitionblock > table td.icon { padding-top: 15px; padding-bottom: 20px; }
.admonitionblock > table td.content { border-left: 0; padding: 15px 25px 20px 15px; }

.imageblock { border: 1px solid #d8d8d8; margin-top: 3.125em; margin-bottom: 3.125em; padding: 15px 15px 5px 15px; }
.imageblock > .content { text-align: center; }
.imageblock > .title { font-weight: normal; font-style: italic; letter-spacing: 0.5px; margin-top: 0.375em; margin-bottom: 0; }

.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 5px 5px 0 0; border-radius: 5px 5px 0 0; border: 0; }

pre .conum { background: white; color: #191919 !important; }
pre .conum * { color: #191919 !important; }

.sidebarblock { border-color: #bfbfbf; }

table.tableblock.grid-all { -webkit-border-radius: 0; border-radius: 0; border: 0; border-collapse: collapse; }
table.tableblock.grid-all > thead > tr { border-bottom: 2px solid #d8d8d8; }
table.tableblock.grid-all > tbody > tr { border-bottom: 1px solid #d8d8d8; }

#footer { border-top: 1px dashed #d8d8d8; }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Advanced Vert.x Guide</h1>
<div class="details">
<span id="author" class="author">Julien Viet</span><br>
<span id="email" class="email"><a href="mailto:julien@julienviet.com">julien@julienviet.com</a></span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_contexts-in-vert-x">Contexts in Vert.x</a>
<ul class="sectlevel2">
<li><a href="#_verticles">Verticles</a></li>
<li><a href="#_propagation-of-contexts">Propagation of contexts</a></li>
<li><a href="#_adhoc-contexts">Adhoc contexts</a></li>
<li><a href="#_dealing-with-contexts">Dealing with contexts</a></li>
<li><a href="#_event-loop-context">Event-loop context</a></li>
<li><a href="#_worker-context">Worker context</a></li>
<li><a href="#_context-exception-handler">Context exception handler</a></li>
<li><a href="#_contexts-and-tracing">Contexts and tracing</a></li>
<li><a href="#_context-internals">Context internals</a></li>
</ul>
</li>
<li><a href="#integrating-netty">Integrating Netty</a>
<ul class="sectlevel2">
<li><a href="#_netty-integration-points">Netty integration points</a></li>
<li><a href="#_the-server">The server</a></li>
<li><a href="#_the-server-bootstrap">The server bootstrap</a></li>
<li><a href="#_the-server-bind">The server bind</a></li>
<li><a href="#_the-server-handler">The server handler</a></li>
<li><a href="#_the-client">The client</a></li>
<li><a href="#_the-client-bootstrap">The client bootstrap</a></li>
<li><a href="#_the-client-connect">The client connect</a></li>
<li><a href="#_the-client-handler">The client handler</a></li>
</ul>
</li>
<li><a href="#_using-netty-tcp-codecs">Using Netty TCP codecs</a>
<ul class="sectlevel2">
<li><a href="#_the-memcached-client">The Memcached client</a></li>
<li><a href="#_anatomy-of-the-memcached-client">Anatomy of the Memcached client</a></li>
<li><a href="#_the-memcached-codec">The Memcached codec</a></li>
<li><a href="#_connecting-to-the-server">Connecting to the server</a></li>
<li><a href="#_request-response-correlation">Request / response correlation</a></li>
<li><a href="#_sending-memcached-request-messages">Sending Memcached request messages</a></li>
<li><a href="#_processing-memcached-response-messages">Processing Memcached response messages</a></li>
<li><a href="#_sending-memcached-get-requests">Sending Memcached GET requests</a></li>
<li><a href="#_processing-memcached-get-responses">Processing Memcached GET responses</a></li>
<li><a href="#_sending-memcached-set-requests">Sending Memcached SET requests</a></li>
<li><a href="#_processing-memcached-set-responses">Processing Memcached SET responses</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This guide document advanced/internal stuff about Vert.x.</p>
</div>
<div class="paragraph">
<p>It aims to explain and discuss the following</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vert.x design</p>
</li>
<li>
<p>Internal APIs</p>
</li>
<li>
<p>Integration with Netty</p>
</li>
<li>
<p>Code generation (TBD)</p>
</li>
<li>
<p>Metrics SPI (TBD)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You want to read this guide when you want to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>understand better Vert.x design</p>
</li>
<li>
<p>integrate Vert.x with other libraries</p>
</li>
<li>
<p>perform networking with Netty and Vert.x</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is a live guide and you can contribute, just open a PR or an issue in the <a href="https://github.com/vietj/advanced-vertx-guide">repo</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Some of the internal Vert.x APIs are exposed in this guide and you should keep in mind that these APIs are subject to
be changed when it is needed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_contexts-in-vert-x">Contexts in Vert.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>io.vertx.core.Context</code> interface is an essential component of Vert.x.</p>
</div>
<div class="paragraph">
<p>At a high level contexts can be thought of as controlling the execution of how events (or tasks created by handlers) are executed by the application.</p>
</div>
<div class="paragraph">
<p>Most events are dispatched through contexts, when the application consumes an event there is most likely a context associated with
the dispatch of the event.</p>
</div>
<div class="sect2">
<h3 id="_verticles">Verticles</h3>
<div class="paragraph">
<p>When an instance of a verticle is deployed, Vert.x creates and associates a context with this instance. You can access
this context in your verticle using the <code>context</code> field of <code>AbstractVerticle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyVerticle extends AbstractVerticle {
 public void start() {
   JsonObject config = context.config();
 }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>MyVerticle</code> is deployed, Vert.x emits a <em>start</em> event, the <code>start</code> method is called by a thread of the Verticle context:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>by default the context is always an event-loop context, the caller thread is an event-loop</p>
</li>
<li>
<p>when the verticle is deployed as a worker the caller thread is one of the worker pool of Vert.x</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_propagation-of-contexts">Propagation of contexts</h3>
<div class="paragraph">
<p>Most Vert.x APIs are aware of contexts.</p>
</div>
<div class="paragraph">
<p>Asynchronous operations executed within a context will call back the application with the same context.</p>
</div>
<div class="paragraph">
<p>Likewise, event handlers are also dispatched on the same context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyVerticle extends AbstractVerticle {
 public void start() {
   Future&lt;HttpServer&gt; future = vertx.createHttpServer()
     .requestHandler(request -&gt; {
       // Executed in the verticle context
     })
     .listen(8080, "localhost");

   future.onComplete(ar -&gt; {
      // Executed in the verticle context
   });
 }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adhoc-contexts">Adhoc contexts</h3>
<div class="paragraph">
<p>Using Vert.x APIs without using Verticle is supported since Vert.x 3 and leads to the interesting question of
which context is used. When a Vert.x API is called, Vert.x associates the current thread with an ad hoc context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Main {
 public static void main(String[] args) {
   WebClient client = WebClient.create(vertx);

   for (int i = 0;i &lt; 4;i++) {
     client
       .get(8080, "myserver.mycompany.com", "/some-uri")
       .send()
       .onSuccess(ar -&gt; {
        // All callbacks are on the same context
       });
   }
 }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
this behavior differs from previous major versions, Vert.x 3 would create a different context for each HTTP request.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_dealing-with-contexts">Dealing with contexts</h3>
<div class="paragraph">
<p>Most application don&#8217;t need tight interactions with a context but sometimes it can be useful to access them, e.g
your application uses another library that performs a callback on its own thread and you want to execute code
in the original context.</p>
</div>
<div class="paragraph">
<p>Above we have seen a verticle can access its context through the <code>context</code> field but that implies to use a verticle
and to have a reference on the verticle which might not always be handy.</p>
</div>
<div class="paragraph">
<p>You can get the current context with <code>getOrCreateContext()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Context context = vertx.getOrCreateContext();</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use the static method <code>Vertx.currentContext()</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Context context = Vertx.currentContext();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The later might return null if the current thread is not associated with a context, whereas the former will create
one if needed and thus never returns null.</p>
</div>
<div class="paragraph">
<p>After you obtained a context, you can use it to run code in this context:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public void integrateWithExternalSystem(Handler&lt;Event&gt; handler) {
 // Capture the current context
 Context context = vertx.getOrCreateContext();

 // Run the event handler on the application context
 externalSystem.onEvent(event -&gt; {
   context.runOnContext(v -&gt; handler.handle(event));
 });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In practice, many Vert.x APIs and thirdparty libraries are implemented this way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_event-loop-context">Event-loop context</h3>
<div class="paragraph">
<p>An event loop context uses an event loop to run code: handlers are executed directly on the IO threads, as
a consequence:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A handler will always be executed with the same thread</p>
</li>
<li>
<p>A handler must never block the thread, otherwise it will create starvation for all the IO tasks associated
with that event loop.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This behavior allows for a greatly simplified threading model by guaranteeing that associated handlers will
always be executed on the same thread, thus removing the need for synchronization and other locking mechanisms.</p>
</div>
<div class="paragraph">
<p>This is the type of context that is the default and most commonly used type of context. A verticle deployed
without the worker flag will always be deployed with an event loop context.</p>
</div>
</div>
<div class="sect2">
<h3 id="_worker-context">Worker context</h3>
<div class="paragraph">
<p>Worker contexts are assigned to verticles deployed with the worker option enabled. The worker context is
differentiated from standard event loop contexts in that workers are executed on a separate worker thread pool.</p>
</div>
<div class="paragraph">
<p>This separation from event loop threads allows worker contexts to execute the types of blocking operations that
will block the event loop: blocking such thread will not impact the application other than blocking one thread.</p>
</div>
<div class="paragraph">
<p>Just as is the case with the event loop context, worker contexts ensure that handlers are only executed on one
thread at any given time. That is, handlers executed on a worker context will always be executed
sequentially - one after the other - but different actions may be executed on different threads.</p>
</div>
</div>
<div class="sect2">
<h3 id="_context-exception-handler">Context exception handler</h3>
<div class="paragraph">
<p>todo</p>
</div>
</div>
<div class="sect2">
<h3 id="_contexts-and-tracing">Contexts and tracing</h3>
<div class="paragraph">
<p>Since Vert.x 4, Vert.x integrates with popular distributing tracing systems.</p>
</div>
<div class="paragraph">
<p>Tracing libraries usually rely on <a href="https://en.wikipedia.org/wiki/Thread-local_storage">thread local storage</a> to
propagate tracing data, e.g a trace received when processing an HTTP request should be propagated throughout the
HTTP client.</p>
</div>
<div class="paragraph">
<p>Vert.x integrates tracing in a similar fashion but relies on contexts instead of thread local. Contexts are indeed
propagated by Vert.x APIs and therefore offers a reliable storage for implementing tracing.</p>
</div>
<div class="paragraph">
<p>Since all HTTP requests processed by a given server use the same context that created the HTTP server, the server context
is <em>duplicated</em> for each HTTP request, to grant unicity to each HTTP request.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyVerticle extends AbstractVerticle {
 public void start() {
   vertx.createHttpServer()
     .requestHandler(request -&gt; {
       // Executed in a duplicate verticle context
     })
     .listen(8080, "localhost");
 }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Duplication shares most of the characteristics of the original context and provides a specific local storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">vertx.createHttpServer()
 .requestHandler(request -&gt; {
   JsonObject specificRequestData = getRequestData(request);
   Context context = vertx.getOrCreateContext();
   context.putLocal("my-stuff", specificRequestData);
   processRequest(request);
 })
 .listen(8080, "localhost");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Later the application can use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Context context = vertx.getOrCreateContext();
JsonObject specificRequestData = context.getLocal("my-stuff");</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_context-internals">Context internals</h3>
<div class="sect3">
<h4 id="_close-hooks">Close hooks</h4>
<div class="paragraph">
<p>Close hooks is an internal feature of Vert.x useful for creating components that are notified when a <code>Verticle</code>
or a <code>Vertx</code> instance is closed. It can be used for implementing <em>automatic clean-up in verticles</em>
feature, like for a Vert.x HTTP server.</p>
</div>
<div class="paragraph">
<p>The contract for receving a close notification is defined by the <code>io.vertx.core.Closeable</code> interface and
its <code>close(Promise&lt;Void&gt; closePromise)</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
public void close(Promise&lt;Void&gt; completion) {
 // Do cleanup, the method will complete the future
  doClose(completion);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>Closeable</code> instance can be registered to receive a close hook with the method</p>
</div>
<div class="paragraph">
<p>The method <code>ContextInternal#addCloseHook</code> registers a <code>Closeable</code> instance to be notified when the context closes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">context.addCloseHook(closeable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Context created by a Verticle deployment signals calls the hook when the verticle instance is destroyed.</p>
</div>
<div class="paragraph">
<p>Otherwise the call hook is called when the Vertx instance is closed.</p>
</div>
<div class="paragraph">
<p>The method <code>Context#removeCloseHook</code> unregisters the close hook and shall be used when the resource is closed before
the close hook is called.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">context.removeCloseHook(closeable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Likewise <code>VertxInternal</code> provides the same operation to receive notifications when a <code>Vertx</code> instance is closed.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="integrating-netty">Integrating Netty</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Netty is one of the dependencies of Vert.x. In fact, Netty powers the networking services of Vert.x. Vert.x Core
provides the basic network services one can expect from such library:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TCP</p>
</li>
<li>
<p>HTTP</p>
</li>
<li>
<p>UDP</p>
</li>
<li>
<p>DNS</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are built with various components from Netty. The Netty community has implemented a wide
range of components and this chapter explains how to integrate such components in Vert.x.</p>
</div>
<div class="paragraph">
<p>In this chapter we will build a <a href="https://tools.ietf.org/html/rfc868">TIME</a> prococol client and server. The Netty
documentation provides client/server implementations of this simple protocol, we will focus on the integration
of these components.</p>
</div>
<div class="sect2">
<h3 id="_netty-integration-points">Netty integration points</h3>
<div class="paragraph">
<p>The main purpose of this chapter is to explain some of the Vert.x&#8217;s internal interfaces. Such interfaces are
extensions that exposes low level methods to interact with Netty that are useful for components that
re-use Netty directly.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most users don&#8217;t need to deal with this extension and thus such methods are isolated in an extension interface.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_bootstrapping-clients">Bootstrapping clients</h4>
<div class="paragraph">
<p><code>ContextInternal</code> extends <code>io.vertx.core.Context</code> and exposes various Netty integration points like <code>VertxInternal</code>.</p>
</div>
<div class="paragraph">
<p>Usually contexts are obtained from the <code>Vertx#getOrCreateContext()</code> method that returns the current execution context
or create a new one if necessary: when called in a Verticle, <code>getOrCreateContext()</code> returns the context of this Verticle, when used in a non Vert.x
thread like a <code>main</code> or a unit test, it creates a new one and returns it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Context context = vertx.getOrCreateContext();

// Cast to access extra methods
Internals contextInternal = (Internals) context;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Contexts are always associated with a Netty event loop and thus using this context ensures our components
re-use the same event loop if one existed before or use a new one.</p>
</div>
<div class="paragraph">
<p>The <code>ContextInternal#nettyEventLoop()</code> method returns this particular event loop and we can use it on
<code>Bootstrap</code> (for client) or <code>ServerBoostrap</code> (for server):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ContextInternal contextInt = (ContextInternal) context; <i class="conum" data-value="1"></i><b>(1)</b>
EventLoop eventLoop = contextInt.nettyEventLoop();

Bootstrap bootstrap = new Bootstrap(); <i class="conum" data-value="2"></i><b>(2)</b>
bootstrap.channel(NioSocketChannel.class);
bootstrap.group(eventLoop);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>get the event-loop associated with this context</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>create a bootstrap for the client</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_bootstrapping-servers">Bootstrapping servers</h4>
<div class="paragraph">
<p><code>VertxInternal</code> extends <code>io.vertx.core.Vertx</code>, among all <code>VertxInternal#getAcceptorEventLoopGroup()</code>
returns an <code>EventLoopGroup</code> for accepting connections on a server, it&#8217;s typical usage is on a <code>ServerBootstrap</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ContextInternal contextInt = (ContextInternal) context; <i class="conum" data-value="1"></i><b>(1)</b>
EventLoop eventLoop = contextInt.nettyEventLoop();

VertxInternal vertxInt = contextInt.owner(); <i class="conum" data-value="2"></i><b>(2)</b>
EventLoopGroup acceptorGroup = vertxInt.getAcceptorEventLoopGroup();

ServerBootstrap bootstrap = new ServerBootstrap(); <i class="conum" data-value="3"></i><b>(3)</b>
bootstrap.channel(NioServerSocketChannel.class);
bootstrap.group(acceptorGroup, eventLoop);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>get the event-loop associated with this context</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>get the acceptor event-loop group of Vertx</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>create the boostrap for the server</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_handling-events">Handling events</h4>
<div class="paragraph">
<p>Now that we are more intimate with <code>ContextInternal</code>, let&#8217;s look at how we can use it to handle Netty events such
as network events, channel life cycle, etc&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>The <code>ContextInternal#dispatch</code> methods is used to dispatch events to the application as it ensures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the context concurrency: reuse the current event-loop thread or execute on a worker</p>
</li>
<li>
<p>the thread local association of the current context with the dispatch thread</p>
</li>
<li>
<p>any uncaught exception thrown is reported on the context, such exception is either logged or passed to the <code>Context#exceptionHandler</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a short example showing a server bootstrap</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Handler&lt;ChannelFuture&gt; bindHandler = fut -&gt; {
  if (fut.isSuccess()) {
    // Signal application with bind success
  } else {
    // Signal application with bind error
  }
};

<i class="conum" data-value="1"></i><b>(1)</b>
bootstrap.bind(socketAddress).addListener(new ChannelFutureListener() {
  @Override
  public void operationComplete(ChannelFuture future) throws Exception {
    <i class="conum" data-value="2"></i><b>(2)</b>
    context.dispatch(future, bindHandler);
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typical usage of <code>dispatch</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>listen handler</p>
</li>
<li>
<p>connect handler</p>
</li>
<li>
<p>request handler</p>
</li>
<li>
<p>close handler</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the-server">The server</h3>
<div class="paragraph">
<p>The original server example can be found <a href="https://netty.io/wiki/user-guide-for-4.x.html#wiki-h3-9">here</a>.</p>
</div>
<div class="paragraph">
<p>The Vert.x TIME server exposes a simple API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a static method to create a <code>TimeServer</code></p>
</li>
<li>
<p>two methods: <code>listen</code> to bind a server and <code>close</code> to unbind</p>
</li>
<li>
<p>the <code>requestHandler</code> for setting an handler for handling requests</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface TimeServer {

  /**
   * @return a new time server
   */
  static TimeServer create(Vertx vertx) {
    return new TimeServerImpl(vertx);
  }

  /**
   * Set the handler to be called when a time request happens. The handler should complete
   * the future with the time value.
   *
   * @param handler the handler to be called
   * @return this object
   */
  TimeServer requestHandler(Handler&lt;Promise&lt;Long&gt;&gt; handler);

  /**
   * Start and bind the time server.
   *
   * @param port the server port
   * @param host the server host
   * @param listenHandler the listen result handler
   */
  void listen(int port, String host, Handler&lt;AsyncResult&lt;Void&gt;&gt; listenHandler);

  /**
   * Close the time server.
   */
  void close();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A TIME server serving the current JVM time is then straighforward to implement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Vertx vertx = Vertx.vertx();

// Create the time server
TimeServer server = TimeServer.create(vertx);
server.requestHandler(time -&gt; {
  time.complete(System.currentTimeMillis());
});

// Start the server
server.listen(8037, "0.0.0.0", ar -&gt; {
  if (ar.succeeded()) {
    System.out.println("Server started");
  } else {
    ar.cause().printStackTrace();
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s study now the server implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the-server-bootstrap">The server bootstrap</h3>
<div class="paragraph">
<p>First let&#8217;s have a look at the <code>ServerBootstrap</code> creation and configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">EventLoopGroup acceptorGroup = vertx.getAcceptorEventLoopGroup(); <i class="conum" data-value="1"></i><b>(1)</b>
EventLoop eventLoop = context.nettyEventLoop(); <i class="conum" data-value="2"></i><b>(2)</b>
bootstrap = new ServerBootstrap(); <i class="conum" data-value="3"></i><b>(3)</b>
bootstrap.channel(NioServerSocketChannel.class);
bootstrap.group(acceptorGroup, eventLoop);
bootstrap.childHandler(new ChannelInitializer&lt;Channel&gt;() {
  @Override
  protected void initChannel(Channel ch) throws Exception {
    ChannelPipeline pipeline = ch.pipeline(); <i class="conum" data-value="4"></i><b>(4)</b>
    TimeServerHandler handler = new TimeServerHandler(context, requestHandler);
    pipeline.addLast(handler);
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>VertxInternal</code> returns the event loop group to use as acceptor group</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>ContextInternal</code> returns the event loop to use as child group</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>create and configure the Netty&#8217;s <code>ServerBootstrap</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>configure the channel with the <code>TimeServerHandler</code> initialized with the server <code>requestHandler</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The creation of the <code>ServerBootstrap</code> is quite straightforward and is very similar to the original version.
The main difference is that we reuse the event-loop provided by the Verticle and Vert.x. This ensures that
our server shares the same resources of our application.</p>
</div>
<div class="paragraph">
<p>Notice that the <code>TimeServerHandler</code> is initialized with the server <code>requestHandler</code>, this handler will be
used when serving TIME requests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the-server-bind">The server bind</h3>
<div class="paragraph">
<p>Now let&#8217;s have a look at the bind operation, again it&#8217;s very and does not differ much from the original
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ChannelFuture bindFuture = bootstrap.bind(host, port);
bindFuture.addListener(new ChannelFutureListener() {
  @Override
  public void operationComplete(ChannelFuture future) {
    context.dispatch(v -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

      //
      if (future.isSuccess()) {
        channel = future.channel();
        listenHandler.handle(Future.succeededFuture(null));
      } else {
        listenHandler.handle(Future.failedFuture(future.cause()));
      }
    });
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>use <code>dispatch</code> to dispatch to the application</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>call the listen handler either with a success or a failure</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The most important part is the use of the <code>dispatch</code> method to dispatch the result to the <code>listenHandler</code> in order
to make the application aware of the bind result.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the-server-handler">The server handler</h3>
<div class="paragraph">
<p>Now let&#8217;s finish our server with the <code>TimeServerHandler</code>, which is an adaptation of the Netty&#8217;s
original <a href="https://netty.io/wiki/user-guide-for-4.x.html#wiki-h3-8"><code>TimeServerHandler</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Promise&lt;Long&gt; result = Promise.promise(); <i class="conum" data-value="1"></i><b>(1)</b>

context.dispatch(result, requestHandler); <i class="conum" data-value="2"></i><b>(2)</b>

result.future().onComplete(ar -&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
  if (ar.succeeded()) {  <i class="conum" data-value="4"></i><b>(4)</b>
    ByteBuf time = ctx.alloc().buffer(4);
    time.writeInt((int) (ar.result() / 1000L + 2208988800L));
    ChannelFuture f = ctx.writeAndFlush(time);
    f.addListener((ChannelFutureListener) channelFuture -&gt; ctx.close());
  } else {  <i class="conum" data-value="5"></i><b>(5)</b>
    ctx.close();
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a new blank promise that will be resolved by the <code>requestHandler</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>let the context dispatch to the <code>requestHandler</code> with <code>dispatch</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the future handler is called when the <code>requestHandler</code> implementation completes the associated promise</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>write the current TIME to the channel and close it after</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>the application failed we simply close the socket</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again here, <code>dispatch</code> is used when a TIME request event happens, the promise to be completed is
passed to the <code>requestHandler</code>. When this promise is completed, the handler will either write the
time result to the channel or close it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the-client">The client</h3>
<div class="paragraph">
<p>The original client example can be found <a href="https://netty.io/wiki/user-guide-for-4.x.html#wiki-h3-10">here</a>.</p>
</div>
<div class="paragraph">
<p>The Vert.x time client exposes a simple API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a static method for creating a <code>TimeClient</code></p>
</li>
<li>
<p>the client <code>getTime</code> method for retrieving a time value from a server</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface TimeClient {

  /**
   * @return a new time client
   */
  static TimeClient create(Vertx vertx) {
    return new TimeClientImpl(vertx);
  }

  /**
   * Fetch the current time from a server.
   *
   * @param port the server port
   * @param host the server host name
   * @param resultHandler the asynchronous time result
   */
  void getTime(int port, String host, Handler&lt;AsyncResult&lt;Long&gt;&gt; resultHandler);

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The TIME client is straightforward to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Vertx vertx = Vertx.vertx();

// Create the time client
TimeClient server = TimeClient.create(vertx);

// Fetch the time
server.getTime(8037, "localhost", ar -&gt; {
  if (ar.succeeded()) {
    System.out.println("Time is " + new Date(ar.result()));
  } else {
    ar.cause().printStackTrace();
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s study now the client implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the-client-bootstrap">The client bootstrap</h3>
<div class="paragraph">
<p>First let&#8217;s have a look at the <code>Bootstrap</code> creation and configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">EventLoop eventLoop = context.nettyEventLoop();  <i class="conum" data-value="1"></i><b>(1)</b>

// Create and configure the Netty bootstrap
Bootstrap bootstrap = new Bootstrap(); <i class="conum" data-value="2"></i><b>(2)</b>
bootstrap.group(eventLoop);
bootstrap.channel(NioSocketChannel.class);
bootstrap.option(ChannelOption.SO_KEEPALIVE, true);
bootstrap.handler(new ChannelInitializer&lt;Channel&gt;() {
  @Override
  protected void initChannel(Channel ch) throws Exception {
    ChannelPipeline pipeline = ch.pipeline(); <i class="conum" data-value="4"></i><b>(4)</b>
    pipeline.addLast(new TimeClientHandler(context, resultHandler));
  }
});

return bootstrap;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>ContextInternal</code> returns the event loop to use as child group</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>create and configure the Netty&#8217;s <code>Bootstrap</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>configure the channel with the <code>TimeServerHandler</code> initialized with the server <code>resultHandler</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The creation of the <code>Bootstrap</code> is quite straightforward and is very similar to the original version.
The main difference is that we reuse the event-loop provided by the Verticle. This ensures that our client
reuses the same event-loop than our verticle.</p>
</div>
<div class="paragraph">
<p>Like in the server example we use the <code>ContextInternal</code> to obtain Netty&#8217;s <code>EventLoop</code> to set on the <code>Bootstrap</code>.</p>
</div>
<div class="paragraph">
<p>Notice that the <code>TimeServerHandler</code> is initialized with the client <code>resultHandler</code>, this handler will be
called with the TIME request result.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the-client-connect">The client connect</h3>
<div class="paragraph">
<p>The bootstrap setup is very similar to the original example, in case of a failure the application callback
uses again <code>dispatch</code> for the same reason thatn before.</p>
</div>
<div class="paragraph">
<p>The <code>TimeClientHandler</code> integration uses also <code>dispatch</code> for calling back the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ChannelFuture connectFuture = bootstrap.connect(host, port); <i class="conum" data-value="1"></i><b>(1)</b>
connectFuture.addListener(new ChannelFutureListener() {
  @Override
  public void operationComplete(ChannelFuture future) throws Exception {
    if (!future.isSuccess()) { <i class="conum" data-value="2"></i><b>(2)</b>
      context.dispatch(v -&gt; { <i class="conum" data-value="3"></i><b>(3)</b>
        resultHandler.handle(io.vertx.core.Future.failedFuture(future.cause()));
      });
    }
  }
});</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>connect to the server</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>upon connect error we call the result handler with a failure</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>use <code>executeFromIO</code> to dispatch the connect failure to the application</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We only care of propagating a connect failure to the application, when the bootstrap connects
successfully, the <code>TimeServerHandler</code> will handle the network response to the application.</p>
</div>
<div class="paragraph">
<p>When a connect failure happens, like in the server implementation, <code>dispatch</code> is used to dispatch the
failure to the <code>resultHandler</code> in order to make the application aware of the connect error.</p>
</div>
</div>
<div class="sect2">
<h3 id="_the-client-handler">The client handler</h3>
<div class="paragraph">
<p>Now let&#8217;s finish our client with the <code>TimeServerHandler</code>, which is an adaptation of the Netty&#8217;s
original <a href="https://netty.io/wiki/user-guide-for-4.x.html#wiki-h3-9"><code>TimeClientHandler</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ByteBuf m = (ByteBuf) msg;
long currentTimeMillis;
try {
  currentTimeMillis = (m.readUnsignedInt() - 2208988800L) * 1000L; <i class="conum" data-value="1"></i><b>(1)</b>
  context.dispatch(Future.succeededFuture(currentTimeMillis), resultHandler); <i class="conum" data-value="2"></i><b>(2)</b>
  resultHandler = null; <i class="conum" data-value="3"></i><b>(3)</b>
  ctx.close(); <i class="conum" data-value="4"></i><b>(4)</b>
} finally {
  m.release();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>decode the time response from the server</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>let the context dispatch the result to the <code>resultHandler</code> with <code>dispatch</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>set the <code>resultHandler</code> to <code>null</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>close the channel</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again here, <code>dispatch</code> is used when a TIME response event happens to dispatch the result to the <code>resultHandler</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using-netty-tcp-codecs">Using Netty TCP codecs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous section we have examined how Vert.x and Netty can share resources and the propagation of Netty events
to a Vert.x application. In this section we will study the integration of existing Netty codecs.</p>
</div>
<div class="paragraph">
<p>Netty codecs are great for encapsulating and reusing network protocols encoder and decoder. The base Netty
distribution provides a few codecs for popular protocols such as HTTP, Redis, Memcached or MQTT.</p>
</div>
<div class="paragraph">
<p>Client and server can be built on top of these codecs with Vert.x, e.g the Vert.x HTTP components reuses
Netty&#8217;s HTTP codec, akin for Vert.x the MQTT protocols.</p>
</div>
<div class="paragraph">
<p>Vert.x TCP client/server can be customized to reuse Netty codecs. In fact the channel of a <code>NetSocket</code>
can be used to customize the pipeline and read/write arbitrary messages.</p>
</div>
<div class="paragraph">
<p>There is a lot of value in reusing <code>NetSocket</code> this way</p>
</div>
<div class="ulist">
<ul>
<li>
<p>extend the Vert.x ecosystem, your clients/servers will be fully integrated with this ecosystem, i.e you can
mix and match your middleware with existing Vert.x middleware, filesystem, etc&#8230;&#8203;</p>
</li>
<li>
<p>build on top of <code>NetSocket</code> features</p>
<div class="ulist">
<ul>
<li>
<p>SSL/TLS</p>
</li>
<li>
<p>Domain sockets</p>
</li>
<li>
<p>Client Socks/HTTP proxy handling</p>
</li>
<li>
<p>Server verticle scaling</p>
</li>
<li>
<p>Metrics</p>
</li>
<li>
<p>SNI handling</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this chapter we will write a client, but the same techniques can be applied for writing a server on top of
Netty&#8217;s codec the same way.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
everything achieved in this chapter can be also achieved using the techniques shown in the
     <a href="#integrating-netty">Integrating Netty</a> chapter
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_the-memcached-client">The Memcached client</h3>
<div class="paragraph">
<p>As example we will build in this chapter a simple <a href="https://memcached.org">Memcached</a> client on top of Netty&#8217;s
Memcached binary codec.</p>
</div>
<div class="paragraph">
<p>Memcached is a popular free and open source, high-performance, distributed memory object caching system.</p>
</div>
<div class="paragraph">
<p>There are two versions of the protocol, text and binary. In this section we will build a client for the
binary protocol described in this <a href="https://github.com/memcached/memcached/wiki/BinaryProtocolRevamped">document</a>.</p>
</div>
<div class="paragraph">
<p>The client is very straightforward to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Vertx vertx = Vertx.vertx();

// Create the memcached client
MemcachedClient.connect(vertx, 11211, "localhost", ar1 -&gt; {
  if (ar1.succeeded()) {

    // Connected to memcached
    System.out.println("connected");

    // Get the client
    MemcachedClient client = ar1.result();

    // Put a value
    client.set("foo", "bar", ar2 -&gt; {
      if (ar2.succeeded()) {

        System.out.println("Put successful");

        // Now retrieve the same value
        client.get("foo", ar3 -&gt; {
          if (ar3.succeeded()) {
            String res = ar3.result();
            System.out.println("Get successful " + res + "");
          } else {
            ar3.cause().printStackTrace();
          }
        });
      } else {
        ar2.cause().printStackTrace();
      }
    });
  } else {
    ar1.cause().printStackTrace();
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can easily start a Memcached server with Docker to try this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>&gt; docker run --rm --name my-memcache -p 11211:11211 -d memcached</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_anatomy-of-the-memcached-client">Anatomy of the Memcached client</h3>
<div class="paragraph">
<p>The client provides a simple API for connecting to a Memcached server and get/set entries.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface MemcachedClient {

  /**
   * Connect to memcached, the {@code completionHandler} will get the {@link MemcachedClient} instance.
   */
  static void connect(Vertx vertx, int port, String host, Handler&lt;AsyncResult&lt;MemcachedClient&gt;&gt; completionHandler) {
    MemcachedClientImpl.connect(vertx, port, host, null, completionHandler);
  }

  /**
   * Connect to memcached, the {@code completionHandler} will get the {@link MemcachedClient} instance.
   */
  static void connect(Vertx vertx, int port, String host, NetClientOptions options, Handler&lt;AsyncResult&lt;MemcachedClient&gt;&gt; completionHandler) {
    MemcachedClientImpl.connect(vertx, port, host, options, completionHandler);
  }

  /**
   * Get a cached entry.
   *
   * @param key the entry key
   * @param completionHandler the handler called with the result
   */
  void get(String key, Handler&lt;AsyncResult&lt;@Nullable String&gt;&gt; completionHandler);

  /**
   * Set a cached entry.
   *
   * @param key the entry key
   * @param value the entry value
   * @param completionHandler the handler called with the result
   */
  void set(String key, String value, Handler&lt;AsyncResult&lt;Void&gt;&gt; completionHandler);

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the-memcached-codec">The Memcached codec</h3>
<div class="paragraph">
<p>The Memcached codec provided by Netty takes care of encoding and decoding Netty <code>ByteBuf</code> from and to
Memcached request and response.</p>
</div>
<div class="paragraph">
<p>Our client will only require to use Memcached objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>write <code>FullBinaryMemcacheRequest</code> to the pipeline</p>
<div class="ulist">
<ul>
<li>
<p>has a <code>key</code> property: a <code>ByteBuf</code> to provide the cached entry key</p>
</li>
<li>
<p>has a <code>opCode</code> property: an enum indicating the operation, <code>GET</code> and <code>SET</code></p>
</li>
<li>
<p>has a <code>extras</code> property: a <code>Bytebuf</code> to provide extra information, only used in Memcached <em>SET</em> requests</p>
</li>
<li>
<p>has a <code>content</code> property: a <code>Bytebuf</code> to provide the cached entry value, only used in Memcached <em>SET</em> requests</p>
</li>
</ul>
</div>
</li>
<li>
<p>read <code>FullBinaryMemcacheResponse</code> from the pipeline</p>
<div class="ulist">
<ul>
<li>
<p>has a <code>status</code> property: a value equals to <code>0</code> when the operation went successful</p>
</li>
<li>
<p>has a <code>content</code> property: a <code>Bytebuf</code> to provide the cached entry value, only used in Memcached <em>GET</em> responses</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Memcached provides a richer protocol than <code>GET</code> or <code>SET</code>, but we don&#8217;t cover it in this section, as the goal
is just to be a demonstration and not a complete client
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_connecting-to-the-server">Connecting to the server</h3>
<div class="paragraph">
<p>Let&#8217;s look first at the client connect implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">NetClient client = options != null ? vertx.createNetClient(options) : vertx.createNetClient();

// Connect to the memcached instance
client.connect(port, host, ar -&gt; {
  if (ar.succeeded()) {
    // Get the socket
    NetSocketInternal so = (NetSocketInternal) ar.result();

    // Create the client
    MemcachedClientImpl memcachedClient = new MemcachedClientImpl(so);

    // Initialize the client: configure the pipeline and set the handlers
    memcachedClient.init();

    // Return the memcached instance to the client
    completionHandler.handle(Future.succeededFuture(memcachedClient));
  } else {
    completionHandler.handle(Future.failedFuture(ar.cause()));
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>connect</code> implementation creates a Vert.x <code>NetClient</code> to connect to the actual Memcached server. When the
connect is a success</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the Vert.x <code>NetSocket</code> is casted to <code>NetSocketInternal</code></p>
</li>
<li>
<p>the Memcached client is created and initialized</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>NetSocketInternal</code> is an advanced interface that gives access to a few extra methods that we need to build the client:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>channelHandlerContext()</code> returns the context of the <code>NetSocket</code> Netty&#8217;s handler</p>
</li>
<li>
<p><code>writeMessage(Object, Handler&lt;AsyncResult&lt;Void&gt;&gt;)</code> writes an object to the pipeline</p>
</li>
<li>
<p><code>messsageHandler(Handler&lt;Object&gt;)</code> sets and handler for processing pipeline messages</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Memcached client <code>init</code> method uses some of them to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>initialize the <code>NetSocket</code> with the Memcached codec</p>
</li>
<li>
<p>sets a message handler to process the Memcached responses</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ChannelPipeline pipeline = so.channelHandlerContext().pipeline();

// Add the memcached message aggregator
pipeline.addFirst("aggregator", new BinaryMemcacheObjectAggregator(Integer.MAX_VALUE));

// Add the memcached decoder
pipeline.addFirst("memcached", new BinaryMemcacheClientCodec());

// Set the message handler to process memcached message
so.messageHandler(this::processResponse);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_request-response-correlation">Request / response correlation</h3>
<div class="paragraph">
<p>The Memcached protocol is a <a href="https://en.wikipedia.org/wiki/Protocol_pipelining">pipelined</a> protocol, the responses
are received in the same order than the requests are sent.</p>
</div>
<div class="paragraph">
<p>Therefore the client needs to maintain an <code>inflight</code> FIFO queue which is a simple Java <code>ConcurrentLinkedQueue</code>. When
a request is sent to the Memcached server, the response handler is added to the queue. When the response is received
the handler is dequeued and can process the response.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sending-memcached-request-messages">Sending Memcached request messages</h3>
<div class="paragraph">
<p>The client has a <code>writeRequest</code> method that sends a request to the pipeline:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>write the request message</p>
</li>
<li>
<p>when the write is successful, add the response handler to the <code>inflight</code> queue so the responses can be processed</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">so.writeMessage(request, ar -&gt; {
  if (ar.succeeded()) {
    // The message has been encoded succesfully and sent
    // we add the handler to the inflight queue
    inflight.add(completionHandler);
  } else {
    // The message could not be encoded or sent
    // we signal an error
    completionHandler.handle(Future.failedFuture(ar.cause()));
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_processing-memcached-response-messages">Processing Memcached response messages</h3>
<div class="paragraph">
<p>The client has a <code>processResponse</code> method that is called each time the Memcached codec decodes a response:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>dequeue the response handler</p>
</li>
<li>
<p>release the Netty message since the response messages are pooled, this method must be called otherwise
a memory leak will happen</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FullBinaryMemcacheResponse response = (FullBinaryMemcacheResponse) msg;

try {
  // Get the handler that will process the response
  Handler&lt;AsyncResult&lt;FullBinaryMemcacheResponse&gt;&gt; handler = inflight.poll();

  // Handle the message
  handler.handle(Future.succeededFuture(response));
} finally {
  // Release the referenced counted message
  response.release();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending-memcached-get-requests">Sending Memcached GET requests</h3>
<div class="paragraph">
<p>Memcached <em>GET</em> is fairly straightforward</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a <code>FullBinaryMemcacheRequest</code></p>
<div class="ulist">
<ul>
<li>
<p>set the <code>key</code> property</p>
</li>
<li>
<p>set the <code>opCode</code> property to <code>BinaryMemcacheOpcodes.GET</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>call <code>writeRequest</code> passing the request and providing the response handler</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ByteBuf keyBuf = Unpooled.copiedBuffer(key, StandardCharsets.UTF_8);

// Create the memcached request
FullBinaryMemcacheRequest request = new DefaultFullBinaryMemcacheRequest(keyBuf, Unpooled.EMPTY_BUFFER);

// Set the memcached operation opcode to perform a GET
request.setOpcode(BinaryMemcacheOpcodes.GET);

// Execute the request
writeRequest(request, ar -&gt; {
  if (ar.succeeded()) {
    // Get the response
    processGetResponse(ar.result(), completionHandler);
  } else {
    // Network error
    completionHandler.handle(Future.failedFuture(ar.cause()));
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_processing-memcached-get-responses">Processing Memcached GET responses</h3>
<div class="paragraph">
<p>Memcached <em>GET</em> responses are processed by <code>processGetResponse</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">short status = response.status();
switch (status) {

  case 0:
    // Succesfull get
    String value = response.content().toString(StandardCharsets.UTF_8);
    completionHandler.handle(Future.succeededFuture(value));
    break;

  case 1:
    // Empty response -&gt; null
    completionHandler.handle(Future.succeededFuture());
    break;

  default:
    // Memcached error
    completionHandler.handle(Future.failedFuture(new MemcachedError(status)));
    break;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>status</code> property of the response indicates whether the response is successful or not. We need to pay
special attention when the <code>status</code> is <code>1</code> as the client handles it as a Java <code>null</code> value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sending-memcached-set-requests">Sending Memcached SET requests</h3>
<div class="paragraph">
<p>Memcached <em>SET</em> is straightforward too</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create a <code>FullBinaryMemcacheRequest</code></p>
<div class="ulist">
<ul>
<li>
<p>set the <code>key</code> property</p>
</li>
<li>
<p>set the <code>opCode</code> property to <code>BinaryMemcacheOpcodes.SET</code></p>
</li>
<li>
<p>set the <code>extras</code> property to a the value <code>0xDEADBEEF_00001C20</code></p>
<div class="ulist">
<ul>
<li>
<p><code>0xDEADBEEF</code> must be used per the protocol</p>
</li>
<li>
<p><code>00001C20</code> is the expiration time set to 2 hours</p>
</li>
</ul>
</div>
</li>
<li>
<p>set the <code>value</code> property</p>
</li>
</ul>
</div>
</li>
<li>
<p>call <code>writeRequest</code> passing the request and providing the response handler</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ByteBuf keyBuf = Unpooled.copiedBuffer(key, StandardCharsets.UTF_8);

// Create the memcached request
FullBinaryMemcacheRequest request = new DefaultFullBinaryMemcacheRequest(keyBuf, Unpooled.EMPTY_BUFFER);

// Set the memcached operation opcode to perform a GET
request.setOpcode(BinaryMemcacheOpcodes.GET);

// Execute the request
writeRequest(request, ar -&gt; {
  if (ar.succeeded()) {
    // Get the response
    processGetResponse(ar.result(), completionHandler);
  } else {
    // Network error
    completionHandler.handle(Future.failedFuture(ar.cause()));
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_processing-memcached-set-responses">Processing Memcached SET responses</h3>
<div class="paragraph">
<p>Memcached <em>SET</em> responses are processed by <code>processSetResponse</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">short status = response.status();
if (status == 0) {
  // Succesfull get
  completionHandler.handle(Future.succeededFuture());
} else {
  // Memcached error
  completionHandler.handle(Future.failedFuture(new MemcachedError(status)));
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-08-16 13:18:28 UTC
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow-night-eighties.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>